# Feature Pack: metrics-core
# A HIT feature pack

name: metrics-core
description: "Core metrics system: metric definitions, data sources, ingestion, and fast aggregation APIs"

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
routes:
  - path: /metrics
    page: Dashboard
    roles: [admin]
  - path: /metrics/definitions
    page: Definitions
    roles: [admin]
  - path: /metrics/providers
    page: Providers
    roles: [admin]
  - path: /metrics/providers/[id]
    page: ProviderDetail
    roles: [admin]
  - path: /metrics/integrations
    page: Integrations
    roles: [admin]
  - path: /metrics/integrations/[id]
    page: IntegrationDetail
    roles: [admin]
  - path: /metrics/mappings
    page: Mappings
    roles: [admin]
  - path: /metrics/mappings/[type]
    page: MappingsType
    roles: [admin]
  - path: /metrics/segments
    page: Segments
    roles: [admin]
  - path: /metrics/segments/new
    page: SegmentEdit
    roles: [admin]
  - path: /metrics/segments/[key]/edit
    page: SegmentEdit
    roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
nav:
  - id: metrics-core
    label: Metrics
    path: /metrics
    icon: ChartBar
    group: system
    roles: [admin]
    weight: 910
    showWhen: authenticated
    children:
      - id: metrics-core-definitions
        label: Catalog
        path: /metrics/definitions
        icon: BookOpen
        roles: [admin]
        weight: 100
        showWhen: authenticated
      - id: metrics-core-providers
        label: Providers
        path: /metrics/providers
        icon: Layers
        roles: [admin]
        weight: 105
        showWhen: authenticated
      - id: metrics-core-integrations
        label: Integrations
        path: /metrics/integrations
        icon: Key
        roles: [admin]
        weight: 130
        showWhen: authenticated
      - id: metrics-core-mappings
        label: Mappings
        path: /metrics/mappings
        icon: Link2
        roles: [admin]
        weight: 140
        showWhen: authenticated
      - id: metrics-core-segments
        label: Segments
        path: /metrics/segments
        icon: Filter
        roles: [admin]
        weight: 150
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/metrics-core.ts
  exports:
    - metricsMetricDefinitions
    - metricsDataSources
    - metricsSyncRuns
    - metricsIngestBatches
    - metricsIngestRowErrors
    - metricsLinks
    - metricsPartnerCredentials
    - metricsMetricPoints
    - metricsSegments
    - MetricsMetricDefinition
    - InsertMetricsMetricDefinition
    - MetricsDataSource
    - InsertMetricsDataSource
    - MetricsSyncRun
    - InsertMetricsSyncRun
    - MetricsIngestBatch
    - InsertMetricsIngestBatch
    - MetricsIngestRowError
    - InsertMetricsIngestRowError
    - MetricsLink
    - InsertMetricsLink
    - MetricsPartnerCredential
    - InsertMetricsPartnerCredential
    - MetricsMetricPoint
    - InsertMetricsMetricPoint
    - MetricsSegment
    - InsertMetricsSegment

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/metrics/catalog
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/catalog"
      description: "Get all available metrics with their definitions, categories, units, and data coverage stats. Use this to discover what metrics exist before querying."

    - path: /api/metrics/definitions
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/definitions"
      description: "List metric definitions (GET) or create a definition (POST)"

    - path: /api/metrics/data-sources
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/data-sources"
      description: "List data sources (internal debug)"

    - path: /api/metrics/providers
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers"
      description: "List providers (ingestors + artifacts + preflight + stats)"

    - path: /api/metrics/providers/[id]
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers-id"
      description: "Provider detail (ingestor config + artifacts + preflight)"

    - path: /api/metrics/providers/[id]/targets
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers-id-targets"
      description: "Preview records/targets that a provider will process (config-driven)"

    - path: /api/metrics/ingestors
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors"
      description: "List ingestors from .hit/metrics/ingestors/*.yaml (config-driven)"

    - path: /api/metrics/ingestors/[id]/upload
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors-id-upload"
      description: "Upload a file for an ingestor (file_upload sources)"

    - path: /api/metrics/ingest
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingest"
      description: "Ingest metric points (upsert)"

    - path: /api/metrics/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/query"
      description: "Query metric data with aggregation. Body: {metricKey, start, end, bucket: 'none'|'day'|'week'|'month', agg: 'sum'|'avg'|'max', entityId?, groupByEntityId?: true}. Use bucket='none' for totals, groupByEntityId=true to get per-entity breakdown."

    - path: /api/metrics/query-batch
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/query-batch"
      description: "Batch query metrics. Body: { queries: QueryBody[] }. Returns { results: Array<{data?, meta?, error?}> } in the same order as input."

    - path: /api/metrics/partners
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/partners"
      description: "List integration partners (definitions + configured status)"

    - path: /api/metrics/partners/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id"
      description: "Get/update/delete integration partner credentials"

    - path: /api/metrics/partners/[id]/verify
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id-verify"
      description: "Verify integration partner credentials using configured verify action"

    - path: /api/metrics/links
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/links"
      description: "List or create metrics links (used for mappings and global metadata)"

    - path: /api/metrics/links/[id]
      methods: [PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/links-id"
      description: "Update or delete a metrics link"

    - path: /api/metrics/segments
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments"
      description: "List/create segment definitions (classification layer over entities)"

    - path: /api/metrics/segments/[key]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-key"
      description: "Get/update/delete a segment by key"

    - path: /api/metrics/segments/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-evaluate"
      description: "Evaluate segment membership for a single entity (boolean)"

    - path: /api/metrics/segments/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-query"
      description: "Query segment members (paged entityIds list)"

    - path: /api/metrics/segments/table-buckets
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets"
      description: "List bucket segments linked to a tableId + columnKey (segment-owned table bucketing)"

    - path: /api/metrics/segments/table-buckets/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets"
      description: "Query bucket segment membership per bucket (counts + paged entityIds per bucket)"

    - path: /api/metrics/segments/table-buckets/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets-evaluate"
      description: "Evaluate bucket column value for a set of entityIds (first-match wins)"

    - path: /api/metrics/segments/table-metrics
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-metrics"
      description: "List computed metric columns linked to a tableId (metric-backed table columns)"

    - path: /api/metrics/segments/table-metrics/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-metrics"
      description: "Evaluate computed metric column values for a set of entityIds"

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: []

dependencies:
  feature_packs:
    - name: dashboard-shell
