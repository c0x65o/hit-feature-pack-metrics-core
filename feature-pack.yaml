# Feature Pack: metrics-core
# A HIT feature pack

name: metrics-core
version: 1.0.0
description: "Core metrics system: metric definitions, data sources, ingestion, and fast aggregation APIs"

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
routes:
  - path: /metrics
    page: Dashboard
    roles: [admin]
  - path: /metrics/definitions
    page: Definitions
    roles: [admin]
  - path: /metrics/providers
    page: Providers
    roles: [admin]
  - path: /metrics/providers/[id]
    page: ProviderDetail
    roles: [admin]
  - path: /metrics/ingestors
    page: Ingestors
    roles: [admin]
  - path: /metrics/ingestors/[id]
    page: IngestorDetail
    roles: [admin]
  - path: /metrics/integrations
    page: Integrations
    roles: [admin]
  - path: /metrics/integrations/[id]
    page: IntegrationDetail
    roles: [admin]
  - path: /metrics/mappings
    page: Mappings
    roles: [admin]
  - path: /metrics/mappings/[type]
    page: MappingsType
    roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
nav:
  - id: metrics-core
    label: Metrics
    path: /metrics
    icon: BarChart3
    group: system
    roles: [admin]
    weight: 910
    showWhen: authenticated
    children:
      - id: metrics-core-definitions
        label: Catalog
        path: /metrics/definitions
        icon: BookOpen
        roles: [admin]
        weight: 100
        showWhen: authenticated
      - id: metrics-core-providers
        label: Providers
        path: /metrics/providers
        icon: Layers
        roles: [admin]
        weight: 105
        showWhen: authenticated
      - id: metrics-core-ingestors
        label: Ingestors
        path: /metrics/ingestors
        icon: PackageSearch
        roles: [admin]
        weight: 120
        showWhen: authenticated
      - id: metrics-core-integrations
        label: Integrations
        path: /metrics/integrations
        icon: Key
        roles: [admin]
        weight: 130
        showWhen: authenticated
      - id: metrics-core-mappings
        label: Mappings
        path: /metrics/mappings
        icon: Link2
        roles: [admin]
        weight: 140
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/metrics-core.ts
  exports:
    - metricsMetricDefinitions
    - metricsDataSources
    - metricsSyncRuns
    - metricsIngestBatches
    - metricsIngestRowErrors
    - metricsLinks
    - metricsPartnerCredentials
    - metricsMetricPoints
    - MetricsMetricDefinition
    - InsertMetricsMetricDefinition
    - MetricsDataSource
    - InsertMetricsDataSource
    - MetricsSyncRun
    - InsertMetricsSyncRun
    - MetricsIngestBatch
    - InsertMetricsIngestBatch
    - MetricsIngestRowError
    - InsertMetricsIngestRowError
    - MetricsLink
    - InsertMetricsLink
    - MetricsPartnerCredential
    - InsertMetricsPartnerCredential
    - MetricsMetricPoint
    - InsertMetricsMetricPoint

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/metrics/catalog
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/catalog"
      description: "Get compiled metrics catalog with live data coverage stats"

    - path: /api/metrics/definitions
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/definitions"
      description: "List metric definitions (GET) or create a definition (POST)"

    - path: /api/metrics/data-sources
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/data-sources"
      description: "List data sources (internal debug)"

    - path: /api/metrics/providers
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers"
      description: "List providers (ingestors + artifacts + preflight + stats)"

    - path: /api/metrics/providers/[id]
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers-id"
      description: "Provider detail (ingestor config + artifacts + preflight)"

    - path: /api/metrics/ingestors
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors"
      description: "List ingestors from .hit/metrics/ingestors/*.yaml (config-driven)"

    - path: /api/metrics/ingestors/[id]/upload
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors-id-upload"
      description: "Upload a file for an ingestor (file_upload sources)"

    - path: /api/metrics/ingest
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingest"
      description: "Ingest metric points (upsert)"

    - path: /api/metrics/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/query"
      description: "Fast aggregated query over metric points (bucketing, grouping, filtering)"

    - path: /api/metrics/partners
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/partners"
      description: "List integration partners (definitions + configured status)"

    - path: /api/metrics/partners/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id"
      description: "Get/update/delete integration partner credentials"

    - path: /api/metrics/partners/[id]/verify
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id-verify"
      description: "Verify integration partner credentials using configured verify action"

    - path: /api/metrics/links
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/links"
      description: "List or create metrics links (used for mappings and global metadata)"

    - path: /api/metrics/links/[id]
      methods: [PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/links-id"
      description: "Update or delete a metrics link"

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: []

dependencies:
  feature_packs:
    - name: dashboard-shell
