# Feature Pack: metrics-core
# A HIT feature pack

name: metrics-core
title: System Metrics
description: "Core metrics system: metric definitions, data sources, ingestion, and fast aggregation APIs"

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
routes:
  - path: /metrics
    page: Dashboard
    roles: []
    default_roles_allow: [admin]
    authz: { entity: metrics, verb: read }
  - path: /metrics/definitions
    page: Definitions
    roles: []
    default_roles_allow: [admin]
    authz: { entity: definitions, verb: read }
  - path: /metrics/providers
    page: Providers
    roles: []
    default_roles_allow: [admin]
    authz: { entity: providers, verb: read }
  - path: /metrics/providers/[id]
    page: ProviderDetail
    roles: []
    default_roles_allow: [admin]
    authz: { entity: providers, verb: read }
  - path: /metrics/integrations
    page: Integrations
    roles: []
    default_roles_allow: [admin]
    authz: { entity: integrations, verb: read }
  - path: /metrics/integrations/[id]
    page: IntegrationDetail
    roles: []
    default_roles_allow: [admin]
    authz: { entity: integrations, verb: read }
  - path: /metrics/mappings
    page: Mappings
    roles: []
    default_roles_allow: [admin]
    authz: { entity: mappings, verb: read }
  - path: /metrics/mappings/[type]
    page: MappingsType
    roles: []
    default_roles_allow: [admin]
    authz: { entity: mappings, verb: read }
  - path: /metrics/segments
    page: Segments
    roles: []
    default_roles_allow: [admin]
    authz: { entity: segments, verb: read }
  - path: /metrics/segments/new
    page: SegmentEdit
    roles: []
    default_roles_allow: [admin]
    authz: { entity: segments, verb: write, require_create: true }
  - path: /metrics/segments/[key]/edit
    page: SegmentEdit
    roles: []
    default_roles_allow: [admin]
    authz: { entity: segments, verb: write }

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
nav:
  - id: metrics-core
    label: Metrics
    path: /metrics
    icon: ChartBar
    group: system
    roles: [admin]
    weight: 910
    showWhen: authenticated
    children:
      - id: metrics-core-definitions
        label: Catalog
        path: /metrics/definitions
        icon: BookOpen
        roles: [admin]
        weight: 100
        showWhen: authenticated
      - id: metrics-core-providers
        label: Providers
        path: /metrics/providers
        icon: Layers
        roles: [admin]
        weight: 105
        showWhen: authenticated
      - id: metrics-core-integrations
        label: Integrations
        path: /metrics/integrations
        icon: Key
        roles: [admin]
        weight: 130
        showWhen: authenticated
      - id: metrics-core-mappings
        label: Mappings
        path: /metrics/mappings
        icon: Link2
        roles: [admin]
        weight: 140
        showWhen: authenticated
      - id: metrics-core-segments
        label: Segments
        path: /metrics/segments
        icon: Filter
        roles: [admin]
        weight: 150
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/metrics-core.ts
  exports:
    - metricsMetricDefinitions
    - metricsDataSources
    - metricsSyncRuns
    - metricsIngestBatches
    - metricsIngestRowErrors
    - metricsLinks
    - metricsPartnerCredentials
    - metricsMetricPoints
    - metricsSegments
    - MetricsMetricDefinition
    - InsertMetricsMetricDefinition
    - MetricsDataSource
    - InsertMetricsDataSource
    - MetricsSyncRun
    - InsertMetricsSyncRun
    - MetricsIngestBatch
    - InsertMetricsIngestBatch
    - MetricsIngestRowError
    - InsertMetricsIngestRowError
    - MetricsLink
    - InsertMetricsLink
    - MetricsPartnerCredential
    - InsertMetricsPartnerCredential
    - MetricsMetricPoint
    - InsertMetricsMetricPoint
    - MetricsSegment
    - InsertMetricsSegment

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/metrics/catalog
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/catalog"
      description: "Get all available metrics with their definitions, categories, units, and data coverage stats. Use this to discover what metrics exist before querying."

    - path: /api/metrics/definitions
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/definitions"
      description: "List metric definitions (GET) or create a definition (POST)"

    - path: /api/metrics/data-sources
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/data-sources"
      description: "List data sources (internal debug)"

    - path: /api/metrics/providers
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers"
      description: "List providers (ingestors + artifacts + preflight + stats)"

    - path: /api/metrics/providers/[id]
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers-id"
      description: "Provider detail (ingestor config + artifacts + preflight)"

    - path: /api/metrics/providers/[id]/targets
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/providers-id-targets"
      description: "Preview records/targets that a provider will process (config-driven)"

    - path: /api/metrics/ingestors
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors"
      description: "List ingestors from .hit/metrics/ingestors/*.yaml (config-driven)"

    - path: /api/metrics/ingestors/[id]/upload
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingestors-id-upload"
      description: "Upload a file for an ingestor (file_upload sources)"

    - path: /api/metrics/ingest
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/ingest"
      description: "Ingest metric points (upsert)"

    - path: /api/metrics/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/query"
      description: "Query metric data with aggregation. Body: {metricKey, start, end, bucket: 'none'|'day'|'week'|'month', agg: 'sum'|'avg'|'max', entityId?, groupByEntityId?: true}. Use bucket='none' for totals, groupByEntityId=true to get per-entity breakdown."

    - path: /api/metrics/query-batch
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/query-batch"
      description: "Batch query metrics. Body: { queries: QueryBody[] }. Returns { results: Array<{data?, meta?, error?}> } in the same order as input."

    - path: /api/metrics/points
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/points"
      description: "Paged raw metric points listing (drilldown/export). Query params: metricKey, start/end, entityKind/entityId/entityIds, dataSourceId, dimensions (JSON), page/pageSize."

    - path: /api/metrics/drilldown
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/drilldown"
      description: "Derive a point-level filter from an aggregate row context and return underlying points + contributor breakdowns. Body: { baseQuery, rowContext } or { pointFilter }."

    - path: /api/metrics/partners
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/partners"
      description: "List integration partners (definitions + configured status)"

    - path: /api/metrics/partners/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id"
      description: "Get/update/delete integration partner credentials"

    - path: /api/metrics/partners/[id]/verify
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/partners-id-verify"
      description: "Verify integration partner credentials using configured verify action"

    - path: /api/metrics/links
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/links"
      description: "List or create metrics links (used for mappings and global metadata)"

    - path: /api/metrics/links/[id]
      methods: [PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/links-id"
      description: "Update or delete a metrics link"

    - path: /api/metrics/segments
      methods: [GET, POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments"
      description: "List/create segment definitions (classification layer over entities)"

    - path: /api/metrics/segments/[key]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-key"
      description: "Get/update/delete a segment by key"

    - path: /api/metrics/segments/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-evaluate"
      description: "Evaluate segment membership for a single entity (boolean)"

    - path: /api/metrics/segments/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-query"
      description: "Query segment members (paged entityIds list)"

    - path: /api/metrics/segments/table-buckets
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets"
      description: "List bucket segments linked to a tableId + columnKey (segment-owned table bucketing)"

    - path: /api/metrics/segments/table-buckets/query
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets"
      description: "Query bucket segment membership per bucket (counts + paged entityIds per bucket)"

    - path: /api/metrics/segments/table-buckets/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-buckets-evaluate"
      description: "Evaluate bucket column value for a set of entityIds (first-match wins)"

    - path: /api/metrics/segments/table-metrics
      methods: [GET]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-metrics"
      description: "List computed metric columns linked to a tableId (metric-backed table columns)"

    - path: /api/metrics/segments/table-metrics/evaluate
      methods: [POST]
      handler: "@hit/feature-pack-metrics-core/server/api/segments-table-metrics"
      description: "Evaluate computed metric column values for a set of entityIds"

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: []

dependencies:
  feature_packs:
    - name: erp-shell-core

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Scope Policy Tree: metrics-core (global) -> entity overrides.
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - any: ignore scope (read everything)
    # - own: only owned records (metrics-core doesn't have ownership fields, so this denies access)
    # - ldd: owner OR matching L/D/D (metrics-core doesn't have LDD fields, so this denies access)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    # Note: Metrics-core entities don't have ownership or LDD fields, so `own` and `ldd` modes deny access (only `any` mode allows access).
    - key: metrics-core.read.scope.none
      label: "Metrics Core Read Scope = None"
      description: "Deny all metrics-core read access."
      default_enabled: false
    - key: metrics-core.read.scope.any
      label: "Metrics Core Read Scope = Any"
      description: "Read all metrics-core entities regardless of scope."
      default_enabled: false
    - key: metrics-core.read.scope.own
      label: "Metrics Core Read Scope = Own"
      description: "Read only metrics-core entities you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.write.scope.none
      label: "Metrics Core Write Scope = None"
      description: "Deny all metrics-core write access."
      default_enabled: false
    - key: metrics-core.write.scope.any
      label: "Metrics Core Write Scope = Any"
      description: "Edit metrics-core entities regardless of scope."
      default_enabled: false
    - key: metrics-core.write.scope.own
      label: "Metrics Core Write Scope = Own"
      description: "Edit only metrics-core entities you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.delete.scope.none
      label: "Metrics Core Delete Scope = None"
      description: "Deny all metrics-core delete access."
      default_enabled: false
    - key: metrics-core.delete.scope.any
      label: "Metrics Core Delete Scope = Any"
      description: "Delete metrics-core entities regardless of scope."
      default_enabled: false
    - key: metrics-core.delete.scope.own
      label: "Metrics Core Delete Scope = Own"
      description: "Delete only metrics-core entities you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    # Definitions override (optional): if set, overrides metrics-core.read.scope.* for definitions only.
    - key: metrics-core.definitions.read.scope.none
      label: "Metrics Core Definitions Read Scope = None"
      description: "Deny all definition read access."
      default_enabled: false
    - key: metrics-core.definitions.read.scope.any
      label: "Metrics Core Definitions Read Scope = Any"
      description: "Read definitions regardless of scope."
      default_enabled: false
    - key: metrics-core.definitions.read.scope.own
      label: "Metrics Core Definitions Read Scope = Own"
      description: "Read only definitions you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.definitions.write.scope.none
      label: "Metrics Core Definitions Write Scope = None"
      description: "Deny all definition write access."
      default_enabled: false
    - key: metrics-core.definitions.write.scope.any
      label: "Metrics Core Definitions Write Scope = Any"
      description: "Edit definitions regardless of scope."
      default_enabled: false
    - key: metrics-core.definitions.write.scope.own
      label: "Metrics Core Definitions Write Scope = Own"
      description: "Edit only definitions you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.definitions.create
      label: Create Metric Definition
      description: "Create a new metric definition."
      default_enabled: false

    # Providers override
    - key: metrics-core.providers.read.scope.none
      label: "Metrics Core Providers Read Scope = None"
      description: "Deny all provider read access."
      default_enabled: false
    - key: metrics-core.providers.read.scope.any
      label: "Metrics Core Providers Read Scope = Any"
      description: "Read providers regardless of scope."
      default_enabled: false
    - key: metrics-core.providers.read.scope.own
      label: "Metrics Core Providers Read Scope = Own"
      description: "Read only providers you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    # Integrations override
    - key: metrics-core.integrations.read.scope.none
      label: "Metrics Core Integrations Read Scope = None"
      description: "Deny all integration read access."
      default_enabled: false
    - key: metrics-core.integrations.read.scope.any
      label: "Metrics Core Integrations Read Scope = Any"
      description: "Read integrations regardless of scope."
      default_enabled: false
    - key: metrics-core.integrations.read.scope.own
      label: "Metrics Core Integrations Read Scope = Own"
      description: "Read only integrations you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.integrations.write.scope.none
      label: "Metrics Core Integrations Write Scope = None"
      description: "Deny all integration write access."
      default_enabled: false
    - key: metrics-core.integrations.write.scope.any
      label: "Metrics Core Integrations Write Scope = Any"
      description: "Edit integrations regardless of scope."
      default_enabled: false
    - key: metrics-core.integrations.write.scope.own
      label: "Metrics Core Integrations Write Scope = Own"
      description: "Edit only integrations you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.integrations.delete.scope.none
      label: "Metrics Core Integrations Delete Scope = None"
      description: "Deny all integration delete access."
      default_enabled: false
    - key: metrics-core.integrations.delete.scope.any
      label: "Metrics Core Integrations Delete Scope = Any"
      description: "Delete integrations regardless of scope."
      default_enabled: false
    - key: metrics-core.integrations.delete.scope.own
      label: "Metrics Core Integrations Delete Scope = Own"
      description: "Delete only integrations you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    # Mappings override
    - key: metrics-core.mappings.read.scope.none
      label: "Metrics Core Mappings Read Scope = None"
      description: "Deny all mapping read access."
      default_enabled: false
    - key: metrics-core.mappings.read.scope.any
      label: "Metrics Core Mappings Read Scope = Any"
      description: "Read mappings regardless of scope."
      default_enabled: false
    - key: metrics-core.mappings.read.scope.own
      label: "Metrics Core Mappings Read Scope = Own"
      description: "Read only mappings you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.mappings.write.scope.none
      label: "Metrics Core Mappings Write Scope = None"
      description: "Deny all mapping write access."
      default_enabled: false
    - key: metrics-core.mappings.write.scope.any
      label: "Metrics Core Mappings Write Scope = Any"
      description: "Edit mappings regardless of scope."
      default_enabled: false
    - key: metrics-core.mappings.write.scope.own
      label: "Metrics Core Mappings Write Scope = Own"
      description: "Edit only mappings you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.mappings.delete.scope.none
      label: "Metrics Core Mappings Delete Scope = None"
      description: "Deny all mapping delete access."
      default_enabled: false
    - key: metrics-core.mappings.delete.scope.any
      label: "Metrics Core Mappings Delete Scope = Any"
      description: "Delete mappings regardless of scope."
      default_enabled: false
    - key: metrics-core.mappings.delete.scope.own
      label: "Metrics Core Mappings Delete Scope = Own"
      description: "Delete only mappings you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.mappings.create
      label: Create Mapping
      description: "Create a new mapping."
      default_enabled: false

    # Segments override
    - key: metrics-core.segments.read.scope.none
      label: "Metrics Core Segments Read Scope = None"
      description: "Deny all segment read access."
      default_enabled: false
    - key: metrics-core.segments.read.scope.any
      label: "Metrics Core Segments Read Scope = Any"
      description: "Read segments regardless of scope."
      default_enabled: false
    - key: metrics-core.segments.read.scope.own
      label: "Metrics Core Segments Read Scope = Own"
      description: "Read only segments you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.segments.write.scope.none
      label: "Metrics Core Segments Write Scope = None"
      description: "Deny all segment write access."
      default_enabled: false
    - key: metrics-core.segments.write.scope.any
      label: "Metrics Core Segments Write Scope = Any"
      description: "Edit segments regardless of scope."
      default_enabled: false
    - key: metrics-core.segments.write.scope.own
      label: "Metrics Core Segments Write Scope = Own"
      description: "Edit only segments you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.segments.delete.scope.none
      label: "Metrics Core Segments Delete Scope = None"
      description: "Deny all segment delete access."
      default_enabled: false
    - key: metrics-core.segments.delete.scope.any
      label: "Metrics Core Segments Delete Scope = Any"
      description: "Delete segments regardless of scope."
      default_enabled: false
    - key: metrics-core.segments.delete.scope.own
      label: "Metrics Core Segments Delete Scope = Own"
      description: "Delete only segments you own (metrics-core doesn't have ownership fields, so this denies access)."
      default_enabled: false

    - key: metrics-core.segments.create
      label: Create Segment
      description: "Create a new segment."
      default_enabled: false
